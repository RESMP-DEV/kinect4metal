# yaml-language-server: $schema=
# Phase 0: Project Rebrand - Legal separation from libfreenect2
# Execute FIRST before any code changes

tasks:
  # ============================================================================
  # PROJECT RENAME
  # ============================================================================

  - name: rename-project-cmake
    prompt: |
      Rename the project from kinect4metal to kinect4metal in `contrib/kinect4metal/CMakeLists.txt`.

      Changes:
      1. Change PROJECT(libfreenect2) to PROJECT(kinect4metal)
      2. Update version to 1.0.0 (major version bump for fork):
         ```cmake
         SET(PROJECT_VER_MAJOR 1)
         SET(PROJECT_VER_MINOR 0)
         SET(PROJECT_VER_PATCH 0)
         ```
      3. Update framework identifier:
         ```cmake
         MACOSX_FRAMEWORK_IDENTIFIER com.resmpdev.kinect4metal
         ```
      4. Update library target name from freenect2 to kinect4metal
      5. Update all references to freenect2Config.cmake to kinect4metalConfig.cmake
    priority: P0
    verify_command: grep -q "PROJECT(kinect4metal)" contrib/kinect4metal/CMakeLists.txt

  - name: rename-header-guard
    prompt: |
      Update header guards and version macros in `contrib/kinect4metal/include/libfreenect2/config.h.in`:

      1. Change LIBFREENECT2_CONFIG_H to KINECT4METAL_CONFIG_H
      2. Change LIBFREENECT2_VERSION to KINECT4METAL_VERSION  
      3. Change LIBFREENECT2_API_VERSION to KINECT4METAL_API_VERSION
      4. Rename all LIBFREENECT2_WITH_* to KINECT4METAL_WITH_*
      5. Update comments to reference kinect4metal

      Keep the copyright header from original kinect4metal but add:
      ```cpp
      /*
       * kinect4metal - macOS native Kinect v2 driver
       * Derived from kinect4metal (https://github.com/OpenKinect/libfreenect2)
       */
      ```
    priority: P0
    dependencies: [rename-project-cmake]
    verify_command: grep -q "KINECT4METAL_CONFIG_H" contrib/kinect4metal/include/libfreenect2/config.h.in

  - name: rename-export-header-template
    prompt: |
      The export header is generated by CMake's GenerateExportHeader. Update CMakeLists.txt 
      to generate kinect4metal_export.h instead of libfreenect2/export.h:

      ```cmake
      GENERATE_EXPORT_HEADER(kinect4metal
        BASE_NAME kinect4metal
        EXPORT_FILE_NAME kinect4metal/export.h
      )
      ```

      Update config.h.in to include the new export header:
      ```cpp
      #include <kinect4metal/export.h>
      #define KINECT4METAL_API KINECT4METAL_EXPORT
      ```
    priority: P0
    dependencies: [rename-header-guard]
    verify_command: grep -q "kinect4metal/export.h" contrib/kinect4metal/CMakeLists.txt

  # ============================================================================
  # INCLUDE DIRECTORY RENAME
  # ============================================================================

  - name: rename-include-dir
    prompt: |
      Rename the include directory structure:

      ```bash
      cd contrib/kinect4metal
      mv include/kinect4metal include/kinect4metal
      mv include/internal/kinect4metal include/internal/kinect4metal
      ```

      This changes the include paths from:
        #include <libfreenect2/libfreenect2.hpp>
      To:
        #include <kinect4metal/kinect4metal.hpp>
    priority: P0
    dependencies: [rename-export-header-template]
    verify_command: test -d contrib/kinect4metal/include/kinect4metal

  - name: rename-main-header
    prompt: |
      Rename `contrib/kinect4metal/include/kinect4metal/libfreenect2.hpp` to `kinect4metal.hpp`:

      ```bash
      mv contrib/kinect4metal/include/kinect4metal/libfreenect2.hpp contrib/kinect4metal/include/kinect4metal/kinect4metal.hpp
      ```

      Update the header guard and namespace references inside the file.
    priority: P0
    dependencies: [rename-include-dir]
    verify_command: test -f contrib/kinect4metal/include/kinect4metal/kinect4metal.hpp

  # ============================================================================
  # SOURCE FILE UPDATES
  # ============================================================================

  - name: update-source-includes
    prompt: |
      Update all #include statements in source files under `contrib/kinect4metal/src/`:

      Replace all occurrences of:
        #include <libfreenect2/...>
      With:
        #include <kinect4metal/...>

      Use sed or similar to batch update:
      ```bash
      find contrib/kinect4metal/src -name "*.cpp" -o -name "*.mm" | \
        xargs sed -i '' 's|libfreenect2/|kinect4metal/|g'
      ```
    priority: P0
    dependencies: [rename-main-header]
    verify_command: "! grep -r 'libfreenect2/' contrib/kinect4metal/src/*.cpp"

  - name: update-example-includes
    prompt: |
      Update includes in example files under `contrib/kinect4metal/examples/`:

      In Protonect.cpp and viewer.cpp, replace:
        #include <libfreenect2/...>
      With:
        #include <kinect4metal/...>
    priority: P0
    dependencies: [update-source-includes]
    verify_command: "! grep -r 'libfreenect2/' contrib/kinect4metal/examples/*.cpp"

  # ============================================================================
  # NAMESPACE RENAME (OPTIONAL - MAINTAIN COMPATIBILITY)
  # ============================================================================

  - name: add-namespace-alias
    prompt: |
      In `contrib/kinect4metal/include/kinect4metal/kinect4metal.hpp`, add a namespace alias
      for backward compatibility:

      ```cpp
      namespace kinect4metal {
        // ... all existing code in kinect4metal namespace
      }

      // Backward compatibility alias
      namespace kinect4metal = kinect4metal;
      ```

      This allows existing code using `libfreenect2::Freenect2` to continue working
      while new code can use `kinect4metal::Freenect2`.
    priority: P1
    dependencies: [update-example-includes]
    verify_command: grep -q "namespace kinect4metal" contrib/kinect4metal/include/kinect4metal/kinect4metal.hpp

  # ============================================================================
  # DIRECTORY RENAME
  # ============================================================================

  - name: rename-contrib-directory
    prompt: |
      Rename the contrib directory from kinect4metal to kinect4metal:

      ```bash
      cd contrib
      mv kinect4metal kinect4metal
      ```

      This is the final step that makes the fork fully separate.

      Note: This will require updating the git submodule configuration in .gitmodules
      if this is tracked as a submodule.
    priority: P1
    dependencies: [add-namespace-alias]
    verify_command: test -d contrib/kinect4metal

  - name: update-gitmodules
    prompt: |
      Update `.gitmodules` to reflect the new directory name:

      Change:
      ```
      [submodule "contrib/kinect4metal"]
        path = contrib/kinect4metal
        url = https://github.com/RESMP-DEV/libfreenect2.git
      ```

      To:
      ```
      [submodule "contrib/kinect4metal"]
        path = contrib/kinect4metal
        url = https://github.com/RESMP-DEV/kinect4metal.git
      ```

      Note: The GitHub repository may need to be renamed from kinect4metal to kinect4metal.
    priority: P1
    dependencies: [rename-contrib-directory]
    verify_command: grep -q "contrib/kinect4metal" .gitmodules

  # ============================================================================
  # COPYRIGHT HEADERS
  # ============================================================================

  - name: update-copyright-headers
    prompt: |
      For all NEW files created during this macOS pivot (Metal shaders, macOS-specific code),
      use this copyright header:

      ```cpp
      /*
       * kinect4metal - macOS native Kinect v2 driver
       * Copyright (c) 2026 RESMP-DEV
       *
       * Derived from kinect4metal (https://github.com/OpenKinect/libfreenect2)
       * Original Copyright (c) 2014 individual OpenKinect contributors.
       *
       * Licensed under the Apache License, Version 2.0 (the "License");
       * you may not use this file except in compliance with the License.
       * You may obtain a copy of the License at
       *
       *     http://www.apache.org/licenses/LICENSE-2.0
       */
      ```

      For MODIFIED original files, add to the existing header:
      ```cpp
      * Modified for kinect4metal - macOS native port
      * Modifications Copyright (c) 2026 RESMP-DEV
      ```
    priority: P2
    dependencies: [rename-contrib-directory]
    verify_command: echo "Manual verification needed for copyright headers"

  # ============================================================================
  # PKGCONFIG AND CMAKE CONFIG
  # ============================================================================

  - name: rename-pkgconfig
    prompt: |
      Update pkg-config template `contrib/kinect4metal/freenect2.pc.in`:

      1. Rename to `kinect4metal.pc.in`
      2. Update contents:
         ```
         prefix=@CMAKE_INSTALL_PREFIX@
         exec_prefix=${prefix}
         includedir=${prefix}/include
         libdir=${prefix}/lib
         
         Name: kinect4metal
         Description: macOS native Kinect v2 driver (derived from libfreenect2)
         Version: @PROJECT_VER@
         Cflags: -I${includedir}
         Libs: -L${libdir} -lkinect4metal
         ```
    priority: P2
    dependencies: [rename-contrib-directory]
    verify_command: test -f contrib/kinect4metal/kinect4metal.pc.in
